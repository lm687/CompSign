### save as one of the datasets of the CompSign package

rm(list = ls())

library(gdata) #dirichlet

gitfolder <- '/Users/lena/Documents/CantabPhD/CDA_in_Cancer/'

exposures560BRCA = read.xls(paste0(gitfolder,                  "data/nature17676-s3/Supplementary.Table.21.Signatures.v3.xlsx"),
                            sheet = 3, header = TRUE, stringsAsFactors=FALSE)
rownames(exposures560BRCA) <- exposures560BRCA[,1]
exposures560BRCA <- exposures560BRCA[,-1]
exposures560BRCA <- exposures560BRCA[,1:(ncol(exposures560BRCA)-2)]
exposures560BRCA_mat <- as.matrix(exposures560BRCA)
exposures560BRCA_mat <- outer(1:nrow(exposures560BRCA_mat), 1:ncol(exposures560BRCA_mat),
                              Vectorize(function(x,y) as.numeric(exposures560BRCA_mat[x,y])))

rownames(exposures560BRCA_mat) <- rownames(exposures560BRCA)
colnames(exposures560BRCA_mat) <- colnames(exposures560BRCA)

## normalize colum-wise
exposures560BRCA_norm <- sweep(exposures560BRCA_mat, 2, colSums(exposures560BRCA), '/')
colSums(exposures560BRCA_norm)

## Metadata

clinical = read.csv("/Users/lena/Documents/CantabPhD/CDA_in_Cancer/data/nature17676-s3/SupplementaryTable1CLINICAL.PATHOLOGY.DATA.FREEZE.ANALYSIS.v4.032015.csv", header = TRUE, stringsAsFactors=FALSE, skip = 1)

if(!all(clinical$sample_name == rownames(exposures560BRCA_norm))){stop('SORT!')}else{

  df_clinical <- data.frame(clinical[,-1])
  rownames(df_clinical) <- rownames(exposures560BRCA_norm)

  library(CompSign)

  ## save as an object of type merged_compositional (i.e. both matrix and metadata)
  Breast560 <- new("merged_compositional",
                   id = 'Breast560',
                   id_samples = rownames(exposures560BRCA_norm),
                   id_signatures = colnames(exposures560BRCA_norm),
                   count_matrix = exposures560BRCA_norm,
                   df = df_clinical
  )
  save(Breast560, file = "../CompSign/data/Breast560.rda")

}


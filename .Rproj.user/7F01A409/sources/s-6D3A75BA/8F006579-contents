##     note: add family history
##     note: everything seems misplaced

rm(list = ls())

matrix <- readRDS("~/Documents/CantabPhD/CDA_in_Cancer/data/tcga_ov_signature_exposures_20180926.rds")

unique(substr(rownames(matrix), 1, 4))

clin <- read.table("~/Documents/CantabPhD/CDA_in_Cancer/data/TCGA_clinical/TCGA_only_clinical.cases_selection.2018-10-29/clinical.tsv",
           stringsAsFactors = FALSE, sep = '\t', header = TRUE, fill = TRUE)
expos <- read.table("~/Documents/CantabPhD//CDA_in_Cancer/data/TCGA_clinical/TCGA_only_clinical.cases_selection.2018-10-29/exposure.tsv",
                   stringsAsFactors = FALSE, sep = '\t', header = TRUE, fill = TRUE)

head(clin$case_id)
head(expos$case_id)

mrg <- match(clin$case_id, expos$case_id)

if(all(clin$case_id == expos$case_id[mrg])){
  expos <-  expos[mrg,]
}

sum(is.na(mrg))

all(clin$case_id == expos$case_id)

MetaD <- cbind(clin, expos[-1])

saveRDS(MetaD, file = '~/Documents/CantabPhD/CDA_in_Cancer/data/TCGA_clinical/clinical_TCGA.rds')

#### check ####
tmp <- readRDS('~/Documents/CantabPhD/CDA_in_Cancer/data/TCGA_clinical/clinical_TCGA.rds')
sapply(colnames(tmp), function(x){print(x); if(length(unique(tmp[,x])) < 3){print(unique(tmp[,x]))}else{print(unique(tmp[,x])[1:3])}})

#### merge codes ####

rownames(matrix)
(MetaD$case_id)
(MetaD$submitter_id)
(MetaD$project_id)

dim(MetaD)
dim(matrix)

matching_rownames_matrix <- rownames(matrix)
## if there's an -[LETTER] in the name, e.g. TCGA-BL-A0C8-a, remove
new_matching_rownames_matrix <- sapply(matching_rownames_matrix, function(x){
  tmp_split <- strsplit(x, '-')[[1]]
  tmp_len_split <- length(tmp_split)
  if (tmp_len_split == 3){
   x
    }else if(tmp_len_split == 4){
      ## need to remove extra
      paste0(tmp_split[1:3], collapse = '-')
      }else{
        stop(cat('error in sample', x))
        }
  })

mtch_matrix <- match(MetaD$submitter_id, new_matching_rownames_matrix)
sum(is.na(mtch_matrix))
## why so many NA??

MetaD$submitter_id[mtch_matrix]

matrix_new <- matrix[mtch_matrix,]

dim(matrix_new)
matrix_new <- matrix_new[!apply(matrix_new, 1, function(x) sum(is.na(x)) == ncol(matrix_new)),]
dim(matrix_new)
dim(matrix)

cat('We have lost', dim(matrix)[1]-dim(matrix_new)[1], 'rows')

## what have we lost?
unique( MetaD$submitter_id[! ( MetaD$submitter_id %in% new_matching_rownames_matrix ) ])[1:10]
unique( new_matching_rownames_matrix[! ( new_matching_rownames_matrix %in% MetaD$submitter_id ) ])[1:10]

## example of a case not in the exposures matrix
new_matching_rownames_matrix[grepl("TCGA-06-5417", new_matching_rownames_matrix)]

## example of a case in the exposures matrix, but with no clinical dat
## these are (partially?) redactions
MetaD$submitter_id[grepl("TCGA-AN-A0FG",  MetaD$submitter_id)] ## these two are the same
MetaD$submitter_id[grepl("TCGA-AN-A0FE",  MetaD$submitter_id)] ## these two are the same

sum(is.na(rownames(matrix)))
## some samples are repeated
hist(table(new_matching_rownames_matrix))

MetaD <- MetaD[MetaD$submitter_id %in% new_matching_rownames_matrix,]

dim(matrix_new)
dim(MetaD)

tmp_new_matching_rownames_matrix <- new_matching_rownames_matrix[mtch_matrix]
tmp_new_matching_rownames_matrix <- tmp_new_matching_rownames_matrix[!is.na(tmp_new_matching_rownames_matrix)]

MetaD$submitter_id == rownames(matrix_new)
all(MetaD$submitter_id == tmp_new_matching_rownames_matrix)

#### save ####
library(CompSign)

CNA_12K_TCGA <- new('merged_compositional')
count_matrix(CNA_12K_TCGA) <- matrix_new
metadata(CNA_12K_TCGA) <- MetaD
id(CNA_12K_TCGA) <- "CNA_12K_TCGA"

save(CNA_12K_TCGA, file = "~/Documents/CantabPhD/CompSign/data/CNA_12K_TCGA.rda")

#### WHAT IS IMPORTANT? ####
dim(clin[clin$project_id == 'TCGA-GBM',])

num_na <- apply(clin[clin$project_id == 'TCGA-GBM',], 2, function(x) sum(x == '--'))
for(k in which(num_na < dim(clin[clin$project_id == 'TCGA-GBM',])[2])){
  cat(names(clin)[k], '\n')
}

cog_neuroblastoma_risk_group

unique(clin[clin$project_id == 'TCGA-GBM','ann_arbor_pathologic_stage'])
for(i in unique(clin[clin$project_id == 'TCGA-GBM','inrg_stage'])){
  cat(i, '\n')
}

unique(clin[clin$project_id == 'TCGA-GBM','morphology'])


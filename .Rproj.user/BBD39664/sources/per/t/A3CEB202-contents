##' Analysis of Temko's study
##' on driver genes and mutational signatures
##'
##' both Temko et all and Poulos et al (PLoS) have a very similar study

rm(list = ls())
setwd(dirname(rstudioapi::getSourceEditorContext()$path))

data_folder <- "../../../data/temko/"
list.files(data_folder)



#' example why one can't test two proportions without
#' taking into account others
#'
#' we have three signatures, and two conditions
set.seed(10)
source("../../../code/functions/SimFunctions.R")
cat_mut <- create_catMut()[-97]
Ncat <- length(cat_mut)
sign <- list()
for(k in 1:3){ ## Create signatures
  sign[[k]] <- MCMCpack::rdirichlet(n = 1,
                                    alpha = rep(1, length(cat_mut)))
}

which.max(apply(do.call('rbind', sign), 2, var))
sign[[1]][32]; sign[[2]][32]; sign[[3]][32]
## let's say the mutation is caused by
cat_mut[32]
### continue

par(mfrow=c(1,1))
proportions <- rdirichlet(100, alpha=c(3, 8, 0.2, 3))
perturbed_proportions <- compositions::perturbe(proportions, c(1.4, 1.3, 1.5, 1))
rbind_proportions <- data.frame(rbind(proportions, perturbed_proportions), grouping=c(rep('Condition 1', 100), rep('Condition 2', 100)))
rbind_proportions_molten <- melt(rbind_proportions)
rbind_proportions_molten[,'perturbed_signature'] <- 'Perturbed signature'
rbind_proportions_molten[rbind_proportions_molten$variable == 'X4','perturbed_signature'] <- 'Unperturbed signature'

library(RColorBrewer)
bw_minimal <- define_palette(
  swatch = c('black', 'white', '#a7abb2', 'blue', 'brown', 'purple', 'yellow'),
  gradient = c(lower = 'red', upper = 'green')
)
ggthemr(bw_minimal)
ggplot(rbind_proportions_molten,
       aes(x=grouping, y=value, fill=perturbed_signature))+
  geom_boxplot()+
  facet_wrap(.~variable, scales = "free_x", nrow=1)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.title=element_blank())+
  #ggtitle('Example where we have only perturbed one part of the composition (first one)')+
  labs(y='Proportion of exposure', x='')
ggsave("../../../results/simulations/previous_studies_problems/boxplot_significantchange.png", width = 7, height = 3.5)

## test: two sided mann whitney test r
for(i in 1:4){
  cat('Mutational signature #', i, '\n')
  print(wilcox.test(x = rbind_proportions[rbind_proportions$grouping == 'Condition 1',i],
              y = rbind_proportions[rbind_proportions$grouping == 'Condition 2',i]))
}

ilr_transformation <- ilr(acomp(rbind_proportions[,1:4]))
for(i in 1:3){
  print(wilcox.test(ilr_transformation[rbind_proportions$grouping == 'Condition 1',i],
            ilr_transformation[rbind_proportions$grouping == 'Condition 2',i]))
}

#' Can it be that none of the changes in proportions are statisitically significant except for one,
#' which itself has not changed, because some others have changed?
#' yes, e.g. everything increases ever so slightly
#' precisely in the example above, the only mutation that hasn't been changed is the one that has
#' a statistically significant difference in its proportion

#' exposure to mut signature 1
#'
#' the example in Poulos et al is alrady bizarre, because what does it mean
#' that samples with mutant KRAS have a smaller proportion of mutations
#' attributable to signature 4? so it might be some signature other than 4
#' which is responsible for the KRAS mutation? so why are we testing
#' signature 4, then>

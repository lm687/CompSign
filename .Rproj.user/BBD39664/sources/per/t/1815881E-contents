##' How to get number of mutations attributed to each mutational signature?

rm(list = ls())

library(MCMCpack)
library(signeR)
library(fields)
source("../CDA_in_Cancer/code/functions/SimFunctions.R")

cat_mut <- create_catMut()[-97]
Ncat <- length(cat_mut)

## Create signatures
sign <- list()
for(k in 1:10){
  sign[[k]] <- MCMCpack::rdirichlet(n = 1,
                                    alpha = rep(1, length(cat_mut)))
}

## simutate counts from samples, given exposures per patient
sim_contribution_signatures <- function(){
  cat('Computing\n')
  nsign <- 10
  contribution <- MCMCpack::rdirichlet(1, rep(1, nsign))
  SOME_LARGE_NUMBER <- 1e4
  sim_exposure <- list()
  for(k in 1:nsign){
    sim_exposure[[k]] <- createExposureContinuous(transition_matrix = matrix(c(1, 0, 0, 1),
                                                                             byrow=TRUE, ncol=2),
                                                  signature = sign[[k]],
                                                  emission_kernel='dummy',
                                                  length_out = contribution[k]*SOME_LARGE_NUMBER,
                                                  init_val = 1,
                                                  random_signature = FALSE,
                                                  alpha = 0)
    #aaa <- flatten_emitted_fun(sim_exposure[[1]])
    #    aaa <- aaa[nrow(aaa),]

    ## percentage exposure

  }
  ## image(do.call('rbind', sim_exposure))

  ## alpha = 0: (hidden) chain doesn't move, as shown:
  ## unique(unlist(lapply(sim_exposure, function(x) x$hiddenchain)))

  ## we have ten signatures:
  ## length(sign)

  ## add counts together
  return(list(tab = table(factor(unlist(lapply(sim_exposure, function(x) x$emitted)),
                                 levels=1:Ncat)),
              contribution = contribution))

}

##    [Time consuming]    ##
res_sim_contribution_signatures <- replicate(10, sim_contribution_signatures(),
                                             simplify = FALSE)
to_deconv <- do.call('rbind',
                     lapply(res_sim_contribution_signatures, function(x) x$tab))
colnames(to_deconv) <- cat_mut; rownames(to_deconv) <- paste0('Sample_', 1:nrow(to_deconv))

##                           ##
##       DECONVOLUTION       ##
##                           ##
i <- 5 ## arbitrary rank
cat('Rank:', i, '\n')
nmf_deconv_it <- NMF::nmf(to_deconv,
                               rank = i,
                               seed=134)
rmse <- sqrt(mean(to_deconv-fitted(nmf_deconv_it))**2)

par(mfrow=c(1,2))
image.plot(to_deconv, main='Original')
image.plot(fitted(nmf_deconv_it), main='Deconvoluted')

normalise_NMF_output <- function(raw_signature_mat, raw_exposure_mat, fitted_mat){
  ## w is exposures
  w <- raw_exposure_mat
  ## h is signatures
  h <- raw_signature_mat

  ## we wish rowSums of the signature matrix to add up to the unit, as it's probabilities
  norm_mat <- diag(1/rowSums(h))
  norm_mat2 <- diag(rowSums(h))
  par(mfrow=c(1,2))
  if(!all.equal(fitted_mat, w %*% norm_mat2 %*% norm_mat %*% h)){stop('Problemo')}
  return(list( exposures = (w %*% norm_mat2), signatures = (norm_mat %*% h) ))
}

renormalised <- normalise_NMF_output(raw_exposure_mat = basis(nmf_deconv_it),
                     raw_signature_mat = coef(nmf_deconv_it),
                     fitted_mat = fitted(nmf_deconv_it))

exposures <- renormalised$exposures
signatures <- renormalised$signatures

##' How to get number of mutations attributed to each mutational signature?
to_deconv

##for each of the samples
### for each of the signatures

# x: for each signature
# y: for each sample
lapply(1:10, function(y) sum(sapply(1:5, function(x) (Reduce('+', exposures[y,x] * signatures[x,])))))

lapply(1:5, function(x) sum(sapply(1:10, function(y) (Reduce('+', exposures[y,x] * signatures[x,])))))

no_attributable_muts <- do.call('rbind',
        lapply(1:10, function(i) sapply(1:5, function(k) sum(sapply(1:96, function(j) (sum(exposures[i,k] * signatures[k,j]))))))
)
exposures
#' okay from this is seems as though the exposures matrix IS the number of mutations attributable to each signature
#' ????
